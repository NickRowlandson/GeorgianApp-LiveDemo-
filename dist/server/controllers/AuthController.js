"use strict";
const jwt = require("jsonwebtoken");
const bcrypt = require("bcrypt");
const MailService = require("../services/MailService");
const ActivityService = require("../services/ActivityService");
var sql = require('mssql');
const config = require('../config');
const db = config.db;
const mail = config.mail;
const site_settings = config.site_settings;
class AuthController {
    // Login Authentication
    auth(req, res) {
        try {
            var _username = req.body.username;
            var _password = req.body.password;
            var response;
            sql.connect(db).then(pool => {
                return pool.request()
                    .input('username', sql.VarChar(100), _username)
                    .query("SELECT * FROM Users WHERE username = @username");
            }).then(user => {
                if (user.length > 0) {
                    if (bcrypt.compareSync(_password, user[0].password)) {
                        new ActivityService().reportActivity('user', user[0].userType + ' Login', 'success', '', user[0].userID, _username + ' was successfully logged in.');
                        var token = jwt.sign({ userid: user[0].userID }, "f9b574a2fc0d77986cb7ebe21a0dea480f5f21931abfa5cf329a45ecc0c8e1ff");
                        var statusToken = { status: 200, body: { token: token, userID: user[0].userID, username: user[0].username, userType: user[0].userType, active: user[0].active } };
                        response = JSON.stringify(statusToken);
                    }
                    else {
                        new ActivityService().reportActivity('user', user[0].userType + ' Login', 'fail', '', user[0].userID, _username + ' attempted to log in but entered the wrong password.');
                        response = false;
                    }
                }
                else {
                    new ActivityService().reportActivity('user', 'Login', 'fail', '', '', 'Attempted login as: ' + _username + '. This username does not exist.');
                    response = false;
                }
                res.send(response);
            }).catch(function (err) {
                console.log("Error - Login: " + err);
                res.send({ result: "error", title: "Error", msg: "There was an error with your request.", serverMsg: "" });
            });
        }
        catch (err) {
            console.log("Error - Login: " + err);
            res.send({ result: "error", title: "Error", msg: "There was an error logging in.", serverMsg: "" });
        }
    }
    //Decode token and check if user is authorized
    authUser(req, res, data) {
        try {
            if (req.headers && req.headers.authorization) {
                jwt.verify(req.headers.authorization, 'f9b574a2fc0d77986cb7ebe21a0dea480f5f21931abfa5cf329a45ecc0c8e1ff', function (err, decoded) {
                    if (err) {
                        return res.send({ error: "There was an error" });
                    }
                    else {
                        if (decoded === null || Object.keys(decoded).length === 0) {
                            return res.send({ error: "No values in token" });
                        }
                    }
                    sql.connect(db).then(pool => {
                        return pool.request()
                            .input('userID', sql.Int(), decoded.userid)
                            .query("SELECT * FROM Users WHERE userID = @userID");
                    }).then(user => {
                        var hasSome = data.requiredAuth.some(function (v) {
                            return user[0].userType.indexOf(v) >= 0;
                        });
                        if (hasSome) {
                            try {
                                data.done(decoded.userid);
                            }
                            catch (err) {
                                console.log(err.stack);
                                throw "There was an issue in the logic done after the authentication"; // This will throw to catch on line 83
                            }
                        }
                        else {
                            res.send({ status: '403' });
                        }
                    }).catch(function (err) {
                        console.log("Error - Authenticate user: " + err);
                        res.send({ result: "error", title: "Error", msg: "There was an error with your request.", serverMsg: "" });
                    });
                });
            }
            else {
                res.send({ error: "No auth header" });
            }
        }
        catch (err) {
            console.log("Error - Authenticate user: " + err);
            res.send({ result: "error", title: "Error", msg: "There was an error authenticating the current user.", serverMsg: "" });
        }
    }
    resetPassword(req, res) {
        try {
            var _userID = req.body.userID;
            var _password = req.body.password;
            var salt = bcrypt.genSaltSync(10);
            // Hash the password with the salt
            _password = bcrypt.hashSync(_password, salt);
            sql.connect(db).then(pool => {
                return pool.request()
                    .input('password', sql.VarChar(250), _password)
                    .input('userID', sql.Int(), _userID)
                    .query("UPDATE Users SET password = @password, active = 'true' WHERE userID = @userID");
            }).then(result => {
                res.send({ result: "success", title: "Success!", msg: "Please log in using your new password.", serverMsg: "" });
            }).catch(function (err) {
                console.log(err);
                res.send({ result: "error", title: "Error", msg: "There was an error with your request.", serverMsg: err.message });
            });
        }
        catch (err) {
            console.log("Error - Reset password: " + err);
            res.send({ result: "error", title: "Error", msg: "There was an error resetting your password.", serverMsg: "" });
        }
    }
    requestReset(req, res) {
        try {
            var _email = req.params._email;
            var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            var emailValidation = re.test(_email);
            var randomstring = Math.random().toString(36).slice(-8);
            randomstring = randomstring.charAt(0).toUpperCase() + randomstring.slice(1);
            var salt = bcrypt.genSaltSync(10);
            // Hash the password with the salt
            var _password = bcrypt.hashSync(randomstring, salt);
            if (!emailValidation) {
                res.send({ result: "invalid", title: "Invalid", msg: "Please enter a proper email address. (example@email.com)", serverMsg: "" });
            }
            else {
                sql.connect(db).then(pool => {
                    return pool.request()
                        .input('password', sql.VarChar(250), _password)
                        .input('email', sql.VarChar(100), _email)
                        .query("UPDATE Users SET password = @password, active = 'false' WHERE email = @email; SELECT @@rowcount as 'RowsAffected'");
                }).then(result => {
                    console.dir(result);
                    if (result != null) {
                        // setup email data with unicode symbols
                        let mailOptions = {
                            from: mail.user,
                            to: _email,
                            subject: 'Password Reset',
                            text: '',
                            html: 'Here is your new temporary password: <b>' + randomstring + '</b><br /> Please login at ' + site_settings.url + ' <br /><br /> Thankyou' // html body
                        };
                        new ActivityService().reportActivity('user', 'Request Password Reset', 'success', '', '', 'Password reset accepted. Instructions for login sent to ' + _email + '.');
                        new MailService().sendMessage(" Reset Password", mailOptions);
                    }
                    else {
                        new ActivityService().reportActivity('user', 'Request Password Reset', 'fail', '', '', 'Could not find user with email ' + _email + '.');
                    }
                    res.send({ result: "success", title: "Success!", msg: "Check your email for reset instructions.", serverMsg: "" });
                }).catch(function (err) {
                    console.log(err);
                    res.send({ result: "error", title: "Error", msg: "There was an error with your request.", serverMsg: err.message });
                });
            }
        }
        catch (err) {
            console.log("Error - Request password reset: " + err);
            res.send({ result: "error", title: "Error", msg: "There was an error requesting password reset.", serverMsg: "" });
        }
    }
}
module.exports = AuthController;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9zcmMvY29udHJvbGxlcnMvQXV0aENvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLG9DQUFxQztBQUNyQyxpQ0FBa0M7QUFDbEMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQUM7QUFDdkQsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFDL0QsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNCLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNwQyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsRUFBRSxDQUFDO0FBQ3JCLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDekIsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQztBQUUzQztJQUVFLHVCQUF1QjtJQUN2QixJQUFJLENBQUMsR0FBb0IsRUFBRSxHQUFxQjtRQUM5QyxJQUFJO1lBQ0YsSUFBSSxTQUFTLEdBQVcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDMUMsSUFBSSxTQUFTLEdBQVcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDMUMsSUFBSSxRQUFRLENBQUM7WUFFYixHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDMUIsT0FBTyxJQUFJLENBQUMsT0FBTyxFQUFFO3FCQUNwQixLQUFLLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsU0FBUyxDQUFDO3FCQUM5QyxLQUFLLENBQUMsZ0RBQWdELENBQUMsQ0FBQTtZQUMxRCxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ2IsSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFH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VUFBUyxHQUFHO29CQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUNqQixHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSx1Q0FBdUMsRUFBRSxTQUFTLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7Z0JBQ3RILENBQUMsQ0FBQyxDQUFDO2FBQ047U0FDRjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQ0FBa0MsR0FBRyxHQUFHLENBQUMsQ0FBQztZQUN0RCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSwrQ0FBK0MsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNwSDtJQUNILENBQUM7Q0FFRjtBQUNELGlCQUFTLGNBQWMsQ0FBQyIsImZpbGUiOiJjb250cm9sbGVycy9BdXRoQ29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBleHByZXNzID0gcmVxdWlyZShcImV4cHJlc3NcIik7XHJcbmltcG9ydCBqd3QgPSByZXF1aXJlKCdqc29ud2VidG9rZW4nKTtcclxuaW1wb3J0IGJjcnlwdCA9IHJlcXVpcmUoJ2JjcnlwdCcpO1xyXG5jb25zdCBNYWlsU2VydmljZSA9IHJlcXVpcmUoXCIuLi9zZXJ2aWNlcy9NYWlsU2VydmljZVwiKTtcclxuY29uc3QgQWN0aXZpdHlTZXJ2aWNlID0gcmVxdWlyZShcIi4uL3NlcnZpY2VzL0FjdGl2aXR5U2VydmljZVwiKTtcclxudmFyIHNxbCA9IHJlcXVpcmUoJ21zc3FsJyk7XHJcbmNvbnN0IGNvbmZpZyA9IHJlcXVpcmUoJy4uL2NvbmZpZycpO1xyXG5jb25zdCBkYiA9IGNvbmZpZy5kYjtcclxuY29uc3QgbWFpbCA9IGNvbmZpZy5tYWlsO1xyXG5jb25zdCBzaXRlX3NldHRpbmdzID0gY29uZmlnLnNpdGVfc2V0dGluZ3M7XHJcblxyXG5jbGFzcyBBdXRoQ29udHJvbGxlciB7XHJcblxyXG4gIC8vIExvZ2luIEF1dGhlbnRpY2F0aW9uXHJcbiAgYXV0aChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKTogdm9pZCB7XHJcbiAgICB0cnkge1xyXG4gICAgICB2YXIgX3VzZXJuYW1lOiBzdHJpbmcgPSByZXEuYm9keS51c2VybmFtZTtcclxuICAgICAgdmFyIF9wYXNzd29yZDogc3RyaW5nID0gcmVxLmJvZHkucGFzc3dvcmQ7XHJcbiAgICAgIHZhciByZXNwb25zZTtcclxuXHJcbiAgICAgIHNxbC5jb25uZWN0KGRiKS50aGVuKHBvb2wgPT4ge1xyXG4gICAgICAgIHJldHVybiBwb29sLnJlcXVlc3QoKVxyXG4gICAgICAgIC5pbnB1dCgndXNlcm5hbWUnLCBzcWwuVmFyQ2hhcigxMDApLCBfdXNlcm5hbWUpXHJcbiAgICAgICAgLnF1ZXJ5KFwiU0VMRUNUICogRlJPTSBVc2VycyBXSEVSRSB1c2VybmFtZSA9IEB1c2VybmFtZVwiKVxyXG4gICAgICB9KS50aGVuKHVzZXIgPT4ge1xyXG4gICAgICAgIGlmICh1c2VyLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIGlmIChiY3J5cHQuY29tcGFyZVN5bmMoX3Bhc3N3b3JkLCB1c2VyWzBdLnBhc3N3b3JkKSkge1xyXG4gICAgICAgICAgICBuZXcgQWN0aXZpdHlTZXJ2aWNlKCkucmVwb3J0QWN0aXZpdHkoJ3VzZXInLCB1c2VyWzBdLnVzZXJUeXBlICsgJyBMb2dpbicsICdzdWNjZXNzJywgJycsIHVzZXJbMF0udXNlcklELCBfdXNlcm5hbWUgKyAnIHdhcyBzdWNjZXNzZnVsbHkgbG9nZ2VkIGluLicpO1xyXG4gICAgICAgICAgICB2YXIgdG9rZW4gPSBqd3Quc2lnbih7IHVzZXJpZDogdXNlclswXS51c2VySUQgfSwgXCJmOWI1NzRhMmZjMGQ3Nzk4NmNiN2ViZTIxYTBkZWE0ODBmNWYyMTkzMWFiZmE1Y2YzMjlhNDVlY2MwYzhlMWZmXCIpO1xyXG4gICAgICAgICAgICB2YXIgc3RhdHVzVG9rZW4gPSB7IHN0YXR1czogMjAwLCBib2R5OiB7IHRva2VuOiB0b2tlbiwgdXNlcklEOiB1c2VyWzBdLnVzZXJJRCwgdXNlcm5hbWU6IHVzZXJbMF0udXNlcm5hbWUsIHVzZXJUeXBlOiB1c2VyWzBdLnVzZXJUeXBlLCBhY3RpdmU6IHVzZXJbMF0uYWN0aXZlIH0gfTtcclxuICAgICAgICAgICAgcmVzcG9uc2UgPSBKU09OLnN0cmluZ2lmeShzdGF0dXNUb2tlbik7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBuZXcgQWN0aXZpdHlTZXJ2aWNlKCkucmVwb3J0QWN0aXZpdHkoJ3VzZXInLCB1c2VyWzBdLnVzZXJUeXBlICsgJyBMb2dpbicsICdmYWlsJywgJycsIHVzZXJbMF0udXNlcklELCBfdXNlcm5hbWUgKyAnIGF0dGVtcHRlZCB0byBsb2cgaW4gYnV0IGVudGVyZWQgdGhlIHdyb25nIHBhc3N3b3JkLicpO1xyXG4gICAgICAgICAgICByZXNwb25zZSA9IGZhbHNlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBuZXcgQWN0aXZpdHlTZXJ2aWNlKCkucmVwb3J0QWN0aXZpdHkoJ3VzZXInLCAnTG9naW4nLCAnZmFpbCcsICcnLCAnJywgJ0F0dGVtcHRlZCBsb2dpbiBhczogJyArIF91c2VybmFtZSArICcuIFRoaXMgdXNlcm5hbWUgZG9lcyBub3QgZXhpc3QuJyk7XHJcbiAgICAgICAgICByZXNwb25zZSA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXMuc2VuZChyZXNwb25zZSk7XHJcbiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiRXJyb3IgLSBMb2dpbjogXCIgKyBlcnIpO1xyXG4gICAgICAgIHJlcy5zZW5kKHsgcmVzdWx0OiBcImVycm9yXCIsIHRpdGxlOiBcIkVycm9yXCIsIG1zZzogXCJUaGVyZSB3YXMgYW4gZXJyb3Igd2l0aCB5b3VyIHJlcXVlc3QuXCIsIHNlcnZlck1zZzogXCJcIiB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc29sZS5sb2coXCJFcnJvciAtIExvZ2luOiBcIiArIGVycik7XHJcbiAgICAgIHJlcy5zZW5kKHsgcmVzdWx0OiBcImVycm9yXCIsIHRpdGxlOiBcIkVycm9yXCIsIG1zZzogXCJUaGVyZSB3YXMgYW4gZXJyb3IgbG9nZ2luZyBpbi5cIiwgc2VydmVyTXNnOiBcIlwiIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy9EZWNvZGUgdG9rZW4gYW5kIGNoZWNrIGlmIHVzZXIgaXMgYXV0aG9yaXplZFxyXG4gIGF1dGhVc2VyKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UsIGRhdGEpOiB2b2lkIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGlmIChyZXEuaGVhZGVycyAmJiByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uKSB7XHJcbiAgICAgICAgand0LnZlcmlmeShyZXEuaGVhZGVycy5hdXRob3JpemF0aW9uLCAnZjliNTc0YTJmYzBkNzc5ODZjYjdlYmUyMWEwZGVhNDgwZjVmMjE5MzFhYmZhNWNmMzI5YTQ1ZWNjMGM4ZTFmZicsIGZ1bmN0aW9uKGVyciwgZGVjb2RlZCkge1xyXG4gICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzLnNlbmQoeyBlcnJvcjogXCJUaGVyZSB3YXMgYW4gZXJyb3JcIiB9KTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChkZWNvZGVkID09PSBudWxsIHx8IE9iamVjdC5rZXlzKGRlY29kZWQpLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICAgIHJldHVybiByZXMuc2VuZCh7IGVycm9yOiBcIk5vIHZhbHVlcyBpbiB0b2tlblwiIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBzcWwuY29ubmVjdChkYikudGhlbihwb29sID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHBvb2wucmVxdWVzdCgpXHJcbiAgICAgICAgICAgIC5pbnB1dCgndXNlcklEJywgc3FsLkludCgpLCBkZWNvZGVkLnVzZXJpZClcclxuICAgICAgICAgICAgLnF1ZXJ5KFwiU0VMRUNUICogRlJPTSBVc2VycyBXSEVSRSB1c2VySUQgPSBAdXNlcklEXCIpXHJcbiAgICAgICAgICB9KS50aGVuKHVzZXIgPT4ge1xyXG4gICAgICAgICAgICAgIHZhciBoYXNTb21lID0gZGF0YS5yZXF1aXJlZEF1dGguc29tZShmdW5jdGlvbih2KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdXNlclswXS51c2VyVHlwZS5pbmRleE9mKHYpID49IDA7XHJcbiAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICBpZiAoaGFzU29tZSkge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgZGF0YS5kb25lKGRlY29kZWQudXNlcmlkKTtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIuc3RhY2spO1xyXG4gICAgICAgICAgICAgICAgICB0aHJvdyBcIlRoZXJlIHdhcyBhbiBpc3N1ZSBpbiB0aGUgbG9naWMgZG9uZSBhZnRlciB0aGUgYXV0aGVudGljYXRpb25cIjsgLy8gVGhpcyB3aWxsIHRocm93IHRvIGNhdGNoIG9uIGxpbmUgODNcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzLnNlbmQoeyBzdGF0dXM6ICc0MDMnIH0pO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJFcnJvciAtIEF1dGhlbnRpY2F0ZSB1c2VyOiBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgcmVzLnNlbmQoeyByZXN1bHQ6IFwiZXJyb3JcIiwgdGl0bGU6IFwiRXJyb3JcIiwgbXNnOiBcIlRoZXJlIHdhcyBhbiBlcnJvciB3aXRoIHlvdXIgcmVxdWVzdC5cIiwgc2VydmVyTXNnOiBcIlwiIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXMuc2VuZCh7IGVycm9yOiBcIk5vIGF1dGggaGVhZGVyXCIgfSk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICBjb25zb2xlLmxvZyhcIkVycm9yIC0gQXV0aGVudGljYXRlIHVzZXI6IFwiICsgZXJyKTtcclxuICAgICAgcmVzLnNlbmQoeyByZXN1bHQ6IFwiZXJyb3JcIiwgdGl0bGU6IFwiRXJyb3JcIiwgbXNnOiBcIlRoZXJlIHdhcyBhbiBlcnJvciBhdXRoZW50aWNhdGluZyB0aGUgY3VycmVudCB1c2VyLlwiLCBzZXJ2ZXJNc2c6IFwiXCIgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXNldFBhc3N3b3JkKHJlcTogZXhwcmVzcy5SZXF1ZXN0LCByZXM6IGV4cHJlc3MuUmVzcG9uc2UpOiB2b2lkIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHZhciBfdXNlcklEOiBzdHJpbmcgPSByZXEuYm9keS51c2VySUQ7XHJcbiAgICAgIHZhciBfcGFzc3dvcmQ6IHN0cmluZyA9IHJlcS5ib2R5LnBhc3N3b3JkO1xyXG4gICAgICB2YXIgc2FsdCA9IGJjcnlwdC5nZW5TYWx0U3luYygxMCk7XHJcbiAgICAgIC8vIEhhc2ggdGhlIHBhc3N3b3JkIHdpdGggdGhlIHNhbHRcclxuICAgICAgX3Bhc3N3b3JkID0gYmNyeXB0Lmhhc2hTeW5jKF9wYXNzd29yZCwgc2FsdCk7XHJcblxyXG4gICAgICBzcWwuY29ubmVjdChkYikudGhlbihwb29sID0+IHtcclxuICAgICAgICByZXR1cm4gcG9vbC5yZXF1ZXN0KClcclxuICAgICAgICAuaW5wdXQoJ3Bhc3N3b3JkJywgc3FsLlZhckNoYXIoMjUwKSwgX3Bhc3N3b3JkKVxyXG4gICAgICAgIC5pbnB1dCgndXNlcklEJywgc3FsLkludCgpLCBfdXNlcklEKVxyXG4gICAgICAgIC5xdWVyeShcIlVQREFURSBVc2VycyBTRVQgcGFzc3dvcmQgPSBAcGFzc3dvcmQsIGFjdGl2ZSA9ICd0cnVlJyBXSEVSRSB1c2VySUQgPSBAdXNlcklEXCIpXHJcbiAgICAgIH0pLnRoZW4ocmVzdWx0ID0+IHtcclxuICAgICAgICAgIHJlcy5zZW5kKHsgcmVzdWx0OiBcInN1Y2Nlc3NcIiwgdGl0bGU6IFwiU3VjY2VzcyFcIiwgbXNnOiBcIlBsZWFzZSBsb2cgaW4gdXNpbmcgeW91ciBuZXcgcGFzc3dvcmQuXCIsIHNlcnZlck1zZzogXCJcIiB9KTtcclxuICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICByZXMuc2VuZCh7IHJlc3VsdDogXCJlcnJvclwiLCB0aXRsZTogXCJFcnJvclwiLCBtc2c6IFwiVGhlcmUgd2FzIGFuIGVycm9yIHdpdGggeW91ciByZXF1ZXN0LlwiLCBzZXJ2ZXJNc2c6IGVyci5tZXNzYWdlIH0pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc29sZS5sb2coXCJFcnJvciAtIFJlc2V0IHBhc3N3b3JkOiBcIiArIGVycik7XHJcbiAgICAgIHJlcy5zZW5kKHsgcmVzdWx0OiBcImVycm9yXCIsIHRpdGxlOiBcIkVycm9yXCIsIG1zZzogXCJUaGVyZSB3YXMgYW4gZXJyb3IgcmVzZXR0aW5nIHlvdXIgcGFzc3dvcmQuXCIsIHNlcnZlck1zZzogXCJcIiB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlcXVlc3RSZXNldChyZXE6IGV4cHJlc3MuUmVxdWVzdCwgcmVzOiBleHByZXNzLlJlc3BvbnNlKTogdm9pZCB7XHJcbiAgICB0cnkge1xyXG4gICAgICB2YXIgX2VtYWlsOiBzdHJpbmcgPSByZXEucGFyYW1zLl9lbWFpbDtcclxuICAgICAgdmFyIHJlID0gL14oKFtePD4oKVtcXF1cXFxcLiw7Olxcc0BcXFwiXSsoXFwuW148PigpW1xcXVxcXFwuLDs6XFxzQFxcXCJdKykqKXwoXFxcIi4rXFxcIikpQCgoXFxbWzAtOV17MSwzfVxcLlswLTldezEsM31cXC5bMC05XXsxLDN9XFwuWzAtOV17MSwzfVxcXSl8KChbYS16QS1aXFwtMC05XStcXC4pK1thLXpBLVpdezIsfSkpJC87XHJcbiAgICAgIHZhciBlbWFpbFZhbGlkYXRpb24gPSByZS50ZXN0KF9lbWFpbCk7XHJcbiAgICAgIHZhciByYW5kb21zdHJpbmcgPSBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgtOCk7XHJcbiAgICAgIHJhbmRvbXN0cmluZyA9IHJhbmRvbXN0cmluZy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHJhbmRvbXN0cmluZy5zbGljZSgxKTtcclxuICAgICAgdmFyIHNhbHQgPSBiY3J5cHQuZ2VuU2FsdFN5bmMoMTApO1xyXG4gICAgICAvLyBIYXNoIHRoZSBwYXNzd29yZCB3aXRoIHRoZSBzYWx0XHJcbiAgICAgIHZhciBfcGFzc3dvcmQgPSBiY3J5cHQuaGFzaFN5bmMocmFuZG9tc3RyaW5nLCBzYWx0KTtcclxuICAgICAgaWYgKCFlbWFpbFZhbGlkYXRpb24pIHtcclxuICAgICAgICByZXMuc2VuZCh7IHJlc3VsdDogXCJpbnZhbGlkXCIsIHRpdGxlOiBcIkludmFsaWRcIiwgbXNnOiBcIlBsZWFzZSBlbnRlciBhIHByb3BlciBlbWFpbCBhZGRyZXNzLiAoZXhhbXBsZUBlbWFpbC5jb20pXCIsIHNlcnZlck1zZzogXCJcIiB9KVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgc3FsLmNvbm5lY3QoZGIpLnRoZW4ocG9vbCA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBwb29sLnJlcXVlc3QoKVxyXG4gICAgICAgICAgICAuaW5wdXQoJ3Bhc3N3b3JkJywgc3FsLlZhckNoYXIoMjUwKSwgX3Bhc3N3b3JkKVxyXG4gICAgICAgICAgICAuaW5wdXQoJ2VtYWlsJywgc3FsLlZhckNoYXIoMTAwKSwgX2VtYWlsKVxyXG4gICAgICAgICAgICAucXVlcnkoXCJVUERBVEUgVXNlcnMgU0VUIHBhc3N3b3JkID0gQHBhc3N3b3JkLCBhY3RpdmUgPSAnZmFsc2UnIFdIRVJFIGVtYWlsID0gQGVtYWlsOyBTRUxFQ1QgQEByb3djb3VudCBhcyAnUm93c0FmZmVjdGVkJ1wiKVxyXG4gICAgICAgICAgfSkudGhlbihyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmRpcihyZXN1bHQpO1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0ICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAvLyBzZXR1cCBlbWFpbCBkYXRhIHdpdGggdW5pY29kZSBzeW1ib2xzXHJcbiAgICAgICAgICAgICAgbGV0IG1haWxPcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgZnJvbTogbWFpbC51c2VyLCAvLyBzZW5kZXIgYWRkcmVzc1xyXG4gICAgICAgICAgICAgICAgdG86IF9lbWFpbCwgLy8gbGlzdCBvZiByZWNlaXZlcnNcclxuICAgICAgICAgICAgICAgIHN1YmplY3Q6ICdQYXNzd29yZCBSZXNldCcsIC8vIFN1YmplY3QgbGluZVxyXG4gICAgICAgICAgICAgICAgdGV4dDogJycsIC8vIHBsYWluIHRleHQgYm9keVxyXG4gICAgICAgICAgICAgICAgaHRtbDogJ0hlcmUgaXMgeW91ciBuZXcgdGVtcG9yYXJ5IHBhc3N3b3JkOiA8Yj4nICsgcmFuZG9tc3RyaW5nICsgJzwvYj48YnIgLz4gUGxlYXNlIGxvZ2luIGF0ICcgKyBzaXRlX3NldHRpbmdzLnVybCArICcgPGJyIC8+PGJyIC8+IFRoYW5reW91Jy8vIGh0bWwgYm9keVxyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgbmV3IEFjdGl2aXR5U2VydmljZSgpLnJlcG9ydEFjdGl2aXR5KCd1c2VyJywgJ1JlcXVlc3QgUGFzc3dvcmQgUmVzZXQnLCAnc3VjY2VzcycsICcnLCAnJywgJ1Bhc3N3b3JkIHJlc2V0IGFjY2VwdGVkLiBJbnN0cnVjdGlvbnMgZm9yIGxvZ2luIHNlbnQgdG8gJyArIF9lbWFpbCArICcuJyk7XHJcbiAgICAgICAgICAgICAgbmV3IE1haWxTZXJ2aWNlKCkuc2VuZE1lc3NhZ2UoXCIgUmVzZXQgUGFzc3dvcmRcIiwgbWFpbE9wdGlvbnMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIG5ldyBBY3Rpdml0eVNlcnZpY2UoKS5yZXBvcnRBY3Rpdml0eSgndXNlcicsICdSZXF1ZXN0IFBhc3N3b3JkIFJlc2V0JywgJ2ZhaWwnLCAnJywgJycsICdDb3VsZCBub3QgZmluZCB1c2VyIHdpdGggZW1haWwgJyArIF9lbWFpbCArICcuJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmVzLnNlbmQoeyByZXN1bHQ6IFwic3VjY2Vzc1wiLCB0aXRsZTogXCJTdWNjZXNzIVwiLCBtc2c6IFwiQ2hlY2sgeW91ciBlbWFpbCBmb3IgcmVzZXQgaW5zdHJ1Y3Rpb25zLlwiLCBzZXJ2ZXJNc2c6IFwiXCIgfSk7XHJcbiAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbihlcnIpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICAgICAgICAgICAgcmVzLnNlbmQoeyByZXN1bHQ6IFwiZXJyb3JcIiwgdGl0bGU6IFwiRXJyb3JcIiwgbXNnOiBcIlRoZXJlIHdhcyBhbiBlcnJvciB3aXRoIHlvdXIgcmVxdWVzdC5cIiwgc2VydmVyTXNnOiBlcnIubWVzc2FnZSB9KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc29sZS5sb2coXCJFcnJvciAtIFJlcXVlc3QgcGFzc3dvcmQgcmVzZXQ6IFwiICsgZXJyKTtcclxuICAgICAgcmVzLnNlbmQoeyByZXN1bHQ6IFwiZXJyb3JcIiwgdGl0bGU6IFwiRXJyb3JcIiwgbXNnOiBcIlRoZXJlIHdhcyBhbiBlcnJvciByZXF1ZXN0aW5nIHBhc3N3b3JkIHJlc2V0LlwiLCBzZXJ2ZXJNc2c6IFwiXCIgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxufVxyXG5leHBvcnQgPSBBdXRoQ29udHJvbGxlcjtcclxuIl19
