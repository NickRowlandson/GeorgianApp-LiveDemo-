var schedule = require('node-schedule');
var MailService = require("./MailService");
var sql = require('mssql');
var config = require('../config');
//runs every night at 10pm
var attendanceCheck = schedule.scheduleJob('0 11 56 * * *', function () {
    var date = new Date();
    var str = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
    console.log("Checking student attendance... " + str);
    var missedClasses;
    var student;
    try {
        sql.connect(config.db)
            .then(function (connection) {
            new sql.Request(connection)
                .query("SELECT * FROM Attendance ORDER BY date DESC")
                .then(function (attendanceResult) {
                new sql.Request(connection)
                    .query("SELECT * FROM Students")
                    .then(function (studentsResult) {
                    missedClasses = [];
                    for (var _i = 0, attendanceResult_1 = attendanceResult; _i < attendanceResult_1.length; _i++) {
                        var item = attendanceResult_1[_i];
                        var attendanceDate = new Date();
                        attendanceDate = item.date;
                        var formattedDate = attendanceDate.getDate();
                        if (item.attendanceValue === 'A' && formattedDate === date.getDate()) {
                            missedClasses.push(item);
                        }
                    }
                    if (missedClasses) {
                        var _loop_1 = function (item) {
                            student = studentsResult.filter(function (x) { return x.userID === item.userID; });
                            var mailOptions = {
                                from: 'Academic Career Preparation <academic.career.prep@gmail.com>',
                                to: student[0].email,
                                subject: 'SCHEDULER ✔',
                                text: '',
                                html: '<b> Hi ' + student[0].firstName + '!</b><br  />You have been absent from <insert class name here> for two or more classes in a row.' + item.date + '' // html body
                            };
                            new MailService().scheduledMessage(mailOptions);
                        };
                        for (var _a = 0, missedClasses_1 = missedClasses; _a < missedClasses_1.length; _a++) {
                            var item = missedClasses_1[_a];
                            _loop_1(item);
                        }
                        var mailOptionsAdmin = {
                            from: 'Academic Career Preparation <academic.career.prep@gmail.com>',
                            to: 'academic.career.prep@gmail.com',
                            subject: 'SCHEDULER ✔',
                            text: '',
                            html: '<b> Hi admin!</b><br  />There were ' + missedClasses.length + ' emails sent out due to missed classes.' // html body
                        };
                        new MailService().sendMessage("Scheduled Message", mailOptionsAdmin);
                        console.log("TOTAL EMAILS SENT: " + missedClasses.length);
                    }
                    else {
                        console.log("No missed classes");
                    }
                }).catch(function (err) {
                    console.log("Get all attendance " + err);
                });
            }).catch(function (err) {
                console.log("Get all attendance " + err);
            });
        }).catch(function (err) {
            console.log(err);
        });
    }
    catch (err) {
        console.log(err);
    }
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9zcmMvc2VydmljZXMvU2NoZWR1bGVTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUMxQyxJQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDN0MsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUVsQywwQkFBMEI7QUFDMUIsSUFBSSxlQUFlLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxlQUFlLEVBQUU7SUFDMUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN0QixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsR0FBRyxHQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDL0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsR0FBRyxHQUFHLENBQUMsQ0FBQztJQUNyRCxJQUFJLGFBQWEsQ0FBQztJQUNsQixJQUFJLE9BQU8sQ0FBQztJQUVaLElBQUksQ0FBQztRQUNILEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQzthQUNqQixJQUFJLENBQUMsVUFBUyxVQUFVO1lBQ3JCLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7aUJBQ3RCLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQztpQkFDcEQsSUFBSSxDQUFDLFVBQVMs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Q0FBQyxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxDQUFDO0lBQ1QsQ0FBQztJQUNELEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3JCLENBQUM7QUFFSCxDQUFDLENBQUMsQ0FBQyIsImZpbGUiOiJzZXJ2aWNlcy9TY2hlZHVsZVNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBzY2hlZHVsZSA9IHJlcXVpcmUoJ25vZGUtc2NoZWR1bGUnKTtcclxuY29uc3QgTWFpbFNlcnZpY2UgPSByZXF1aXJlKFwiLi9NYWlsU2VydmljZVwiKTtcclxudmFyIHNxbCA9IHJlcXVpcmUoJ21zc3FsJyk7XHJcbnZhciBjb25maWcgPSByZXF1aXJlKCcuLi9jb25maWcnKTtcclxuXHJcbi8vcnVucyBldmVyeSBuaWdodCBhdCAxMHBtXHJcbnZhciBhdHRlbmRhbmNlQ2hlY2sgPSBzY2hlZHVsZS5zY2hlZHVsZUpvYignMCAxMSA1NiAqICogKicsIGZ1bmN0aW9uKCl7XHJcbiAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gIHZhciBzdHIgPSBkYXRlLmdldEZ1bGxZZWFyKCkgKyBcIi1cIiArIChkYXRlLmdldE1vbnRoKCkgKyAxKSArIFwiLVwiICsgZGF0ZS5nZXREYXRlKCkgKyBcIiBcIiArICBkYXRlLmdldEhvdXJzKCkgKyBcIjpcIiArIGRhdGUuZ2V0TWludXRlcygpICsgXCI6XCIgKyBkYXRlLmdldFNlY29uZHMoKTtcclxuICBjb25zb2xlLmxvZyhcIkNoZWNraW5nIHN0dWRlbnQgYXR0ZW5kYW5jZS4uLiBcIiArIHN0cik7XHJcbiAgdmFyIG1pc3NlZENsYXNzZXM7XHJcbiAgdmFyIHN0dWRlbnQ7XHJcblxyXG4gIHRyeSB7XHJcbiAgICBzcWwuY29ubmVjdChjb25maWcuZGIpXHJcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24oY29ubmVjdGlvbikge1xyXG4gICAgICAgICAgICBuZXcgc3FsLlJlcXVlc3QoY29ubmVjdGlvbilcclxuICAgICAgICAgICAgICAgIC5xdWVyeShcIlNFTEVDVCAqIEZST00gQXR0ZW5kYW5jZSBPUkRFUiBCWSBkYXRlIERFU0NcIilcclxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKGF0dGVuZGFuY2VSZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXcgc3FsLlJlcXVlc3QoY29ubmVjdGlvbilcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnF1ZXJ5KFwiU0VMRUNUICogRlJPTSBTdHVkZW50c1wiKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihzdHVkZW50c1Jlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIG1pc3NlZENsYXNzZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpdGVtIG9mIGF0dGVuZGFuY2VSZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhdHRlbmRhbmNlRGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRlbmRhbmNlRGF0ZSA9IGl0ZW0uZGF0ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmb3JtYXR0ZWREYXRlID0gYXR0ZW5kYW5jZURhdGUuZ2V0RGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uYXR0ZW5kYW5jZVZhbHVlID09PSAnQScgJiYgZm9ybWF0dGVkRGF0ZSA9PT0gZGF0ZS5nZXREYXRlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWlzc2VkQ2xhc3Nlcy5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWlzc2VkQ2xhc3Nlcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaXRlbSBvZiBtaXNzZWRDbGFzc2VzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0dWRlbnQgPSBzdHVkZW50c1Jlc3VsdC5maWx0ZXIoeCA9PiB4LnVzZXJJRCA9PT0gaXRlbS51c2VySUQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWFpbE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnJvbTogJ0FjYWRlbWljIENhcmVlciBQcmVwYXJhdGlvbiA8YWNhZGVtaWMuY2FyZWVyLnByZXBAZ21haWwuY29tPicsIC8vIHNlbmRlciBhZGRyZXNzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IHN0dWRlbnRbMF0uZW1haWwsIC8vIGxpc3Qgb2YgcmVjZWl2ZXJzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogJ1NDSEVEVUxFUiDinJQnLCAvLyBTdWJqZWN0IGxpbmVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnJywgLy8gcGxhaW4gdGV4dCBib2R5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbDogJzxiPiBIaSAnICsgc3R1ZGVudFswXS5maXJzdE5hbWUgKyAnITwvYj48YnIgIC8+WW91IGhhdmUgYmVlbiBhYnNlbnQgZnJvbSA8aW5zZXJ0IGNsYXNzIG5hbWUgaGVyZT4gZm9yIHR3byBvciBtb3JlIGNsYXNzZXMgaW4gYSByb3cuJyArIGl0ZW0uZGF0ZSArICcnIC8vIGh0bWwgYm9keVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXcgTWFpbFNlcnZpY2UoKS5zY2hlZHVsZWRNZXNzYWdlKG1haWxPcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtYWlsT3B0aW9uc0FkbWluID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAnQWNhZGVtaWMgQ2FyZWVyIFByZXBhcmF0aW9uIDxhY2FkZW1pYy5jYXJlZXIucHJlcEBnbWFpbC5jb20+JywgLy8gc2VuZGVyIGFkZHJlc3NcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86ICdhY2FkZW1pYy5jYXJlZXIucHJlcEBnbWFpbC5jb20nLCAvLyBsaXN0IG9mIHJlY2VpdmVyc1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiAnU0NIRURVTEVSIOKclCcsIC8vIFN1YmplY3QgbGluZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnJywgLy8gcGxhaW4gdGV4dCBib2R5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWw6ICc8Yj4gSGkgYWRtaW4hPC9iPjxiciAgLz5UaGVyZSB3ZXJlICcgKyBtaXNzZWRDbGFzc2VzLmxlbmd0aCArICcgZW1haWxzIHNlbnQgb3V0IGR1ZSB0byBtaXNzZWQgY2xhc3Nlcy4nIC8vIGh0bWwgYm9keVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBNYWlsU2VydmljZSgpLnNlbmRNZXNzYWdlKFwiU2NoZWR1bGVkIE1lc3NhZ2VcIiwgbWFpbE9wdGlvbnNBZG1pbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlRPVEFMIEVNQUlMUyBTRU5UOiBcIiArIG1pc3NlZENsYXNzZXMubGVuZ3RoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJObyBtaXNzZWQgY2xhc3Nlc1wiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJHZXQgYWxsIGF0dGVuZGFuY2UgXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiR2V0IGFsbCBhdHRlbmRhbmNlIFwiICsgZXJyKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpO1xyXG4gICAgICAgIH0pO1xyXG4gIH1cclxuICBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgfVxyXG5cclxufSk7XHJcbiJdfQ==
