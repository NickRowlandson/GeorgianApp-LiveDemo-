var schedule = require('node-schedule');
var MailService = require("./MailService");
var sql = require('mssql');
var config = require('../config');
//runs every night at 10pm
var attendanceCheck = schedule.scheduleJob('0 15 15 * * *', function () {
    var date = new Date();
    var str = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
    console.log("Checking student attendance... " + str);
    var missedClasses;
    var student;
    try {
        sql.connect(config.db)
            .then(function (connection) {
            new sql.Request(connection)
                .query("SELECT * FROM Attendance ORDER BY date DESC")
                .then(function (attendanceResult) {
                new sql.Request(connection)
                    .query("SELECT * FROM Students")
                    .then(function (studentsResult) {
                    missedClasses = [];
                    for (var _i = 0, attendanceResult_1 = attendanceResult; _i < attendanceResult_1.length; _i++) {
                        var item = attendanceResult_1[_i];
                        var attendanceDate = new Date();
                        attendanceDate = item.date;
                        var formattedDate = attendanceDate.getDate();
                        if (item.attendanceValue === 'A' && formattedDate === date.getDate()) {
                            missedClasses.push(item);
                        }
                    }
                    if (missedClasses) {
                        var _loop_1 = function (item) {
                            student = studentsResult.filter(function (x) { return x.userID === item.userID; });
                            var mailOptions = {
                                from: '"Test" <ghost@test.com>',
                                to: student[0].email,
                                subject: 'SCHEDULER ✔',
                                text: '',
                                html: '<b> Hi ' + student[0].firstName + '!</b><br  />You have been absent from <insert class name here> for two or more classes in a row.' + item.date + '' // html body
                            };
                            //new MailService().scheduledMessage(mailOptions);
                        };
                        for (var _a = 0, missedClasses_1 = missedClasses; _a < missedClasses_1.length; _a++) {
                            var item = missedClasses_1[_a];
                            _loop_1(item);
                        }
                        var mailOptionsAdmin = {
                            from: '"Test" <academic.career.prep@gmail.com>',
                            to: 'nicholasrowlandson@gmail.com',
                            subject: 'SCHEDULER ✔',
                            text: '',
                            html: '<b> Hi admin!</b><br  />There were ' + missedClasses.length + ' emails sent out due to missed classes.' // html body
                        };
                        new MailService().sendMessage("Scheduled Message", mailOptionsAdmin);
                        console.log("TOTAL EMAILS SENT: " + missedClasses.length);
                    }
                    else {
                        console.log("No missed classes");
                    }
                }).catch(function (err) {
                    console.log("Get all attendance " + err);
                });
            }).catch(function (err) {
                console.log("Get all attendance " + err);
            });
        }).catch(function (err) {
            console.log(err);
        });
    }
    catch (err) {
        console.log(err);
    }
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9zcmMvc2VydmljZXMvU2NoZWR1bGVTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUMxQyxJQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDN0MsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUVsQywwQkFBMEI7QUFDMUIsSUFBSSxlQUFlLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxlQUFlLEVBQUU7SUFDMUQsSUFBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN0QixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsR0FBRyxHQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsRUFBRSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDL0osT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsR0FBRyxHQUFHLENBQUMsQ0FBQztJQUNyRCxJQUFJLGFBQWEsQ0FBQztJQUNsQixJQUFJLE9BQU8sQ0FBQztJQUVaLElBQUksQ0FBQztRQUNILEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQzthQUNqQixJQUFJLENBQUMsVUFBUyxVQUFVO1lBQ3JCLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7aUJBQ3RCLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQztpQkFDcEQsSUFBSSxDQUFDLFVBQVMs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O0lBQ0QsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckIsQ0FBQztBQUVILENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6InNlcnZpY2VzL1NjaGVkdWxlU2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHNjaGVkdWxlID0gcmVxdWlyZSgnbm9kZS1zY2hlZHVsZScpO1xyXG5jb25zdCBNYWlsU2VydmljZSA9IHJlcXVpcmUoXCIuL01haWxTZXJ2aWNlXCIpO1xyXG52YXIgc3FsID0gcmVxdWlyZSgnbXNzcWwnKTtcclxudmFyIGNvbmZpZyA9IHJlcXVpcmUoJy4uL2NvbmZpZycpO1xyXG5cclxuLy9ydW5zIGV2ZXJ5IG5pZ2h0IGF0IDEwcG1cclxudmFyIGF0dGVuZGFuY2VDaGVjayA9IHNjaGVkdWxlLnNjaGVkdWxlSm9iKCcwIDE1IDE1ICogKiAqJywgZnVuY3Rpb24oKXtcclxuICB2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgdmFyIHN0ciA9IGRhdGUuZ2V0RnVsbFllYXIoKSArIFwiLVwiICsgKGRhdGUuZ2V0TW9udGgoKSArIDEpICsgXCItXCIgKyBkYXRlLmdldERhdGUoKSArIFwiIFwiICsgIGRhdGUuZ2V0SG91cnMoKSArIFwiOlwiICsgZGF0ZS5nZXRNaW51dGVzKCkgKyBcIjpcIiArIGRhdGUuZ2V0U2Vjb25kcygpO1xyXG4gIGNvbnNvbGUubG9nKFwiQ2hlY2tpbmcgc3R1ZGVudCBhdHRlbmRhbmNlLi4uIFwiICsgc3RyKTtcclxuICB2YXIgbWlzc2VkQ2xhc3NlcztcclxuICB2YXIgc3R1ZGVudDtcclxuXHJcbiAgdHJ5IHtcclxuICAgIHNxbC5jb25uZWN0KGNvbmZpZy5kYilcclxuICAgICAgICAudGhlbihmdW5jdGlvbihjb25uZWN0aW9uKSB7XHJcbiAgICAgICAgICAgIG5ldyBzcWwuUmVxdWVzdChjb25uZWN0aW9uKVxyXG4gICAgICAgICAgICAgICAgLnF1ZXJ5KFwiU0VMRUNUICogRlJPTSBBdHRlbmRhbmNlIE9SREVSIEJZIGRhdGUgREVTQ1wiKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oYXR0ZW5kYW5jZVJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5ldyBzcWwuUmVxdWVzdChjb25uZWN0aW9uKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAucXVlcnkoXCJTRUxFQ1QgKiBGUk9NIFN0dWRlbnRzXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHN0dWRlbnRzUmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbWlzc2VkQ2xhc3NlcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGl0ZW0gb2YgYXR0ZW5kYW5jZVJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dGVuZGFuY2VEYXRlID0gbmV3IERhdGUoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF0dGVuZGFuY2VEYXRlID0gaXRlbS5kYXRlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZvcm1hdHRlZERhdGUgPSBhdHRlbmRhbmNlRGF0ZS5nZXREYXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5hdHRlbmRhbmNlVmFsdWUgPT09ICdBJyAmJiBmb3JtYXR0ZWREYXRlID09PSBkYXRlLmdldERhdGUoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaXNzZWRDbGFzc2VzLnB1c2goaXRlbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtaXNzZWRDbGFzc2VzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpdGVtIG9mIG1pc3NlZENsYXNzZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R1ZGVudCA9IHN0dWRlbnRzUmVzdWx0LmZpbHRlcih4ID0+IHgudXNlcklEID09PSBpdGVtLnVzZXJJRCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtYWlsT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tOiAnXCJUZXN0XCIgPGdob3N0QHRlc3QuY29tPicsIC8vIHNlbmRlciBhZGRyZXNzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG86IHN0dWRlbnRbMF0uZW1haWwsIC8vIGxpc3Qgb2YgcmVjZWl2ZXJzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogJ1NDSEVEVUxFUiDinJQnLCAvLyBTdWJqZWN0IGxpbmVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAnJywgLy8gcGxhaW4gdGV4dCBib2R5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbDogJzxiPiBIaSAnICsgc3R1ZGVudFswXS5maXJzdE5hbWUgKyAnITwvYj48YnIgIC8+WW91IGhhdmUgYmVlbiBhYnNlbnQgZnJvbSA8aW5zZXJ0IGNsYXNzIG5hbWUgaGVyZT4gZm9yIHR3byBvciBtb3JlIGNsYXNzZXMgaW4gYSByb3cuJyArIGl0ZW0uZGF0ZSArICcnIC8vIGh0bWwgYm9keVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL25ldyBNYWlsU2VydmljZSgpLnNjaGVkdWxlZE1lc3NhZ2UobWFpbE9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1haWxPcHRpb25zQWRtaW4gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb206ICdcIlRlc3RcIiA8YWNhZGVtaWMuY2FyZWVyLnByZXBAZ21haWwuY29tPicsIC8vIHNlbmRlciBhZGRyZXNzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvOiAnbmljaG9sYXNyb3dsYW5kc29uQGdtYWlsLmNvbScsIC8vIGxpc3Qgb2YgcmVjZWl2ZXJzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6ICdTQ0hFRFVMRVIg4pyUJywgLy8gU3ViamVjdCBsaW5lXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6ICcnLCAvLyBwbGFpbiB0ZXh0IGJvZHlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbDogJzxiPiBIaSBhZG1pbiE8L2I+PGJyICAvPlRoZXJlIHdlcmUgJyArIG1pc3NlZENsYXNzZXMubGVuZ3RoICsgJyBlbWFpbHMgc2VudCBvdXQgZHVlIHRvIG1pc3NlZCBjbGFzc2VzLicgLy8gaHRtbCBib2R5XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IE1haWxTZXJ2aWNlKCkuc2VuZE1lc3NhZ2UoXCJTY2hlZHVsZWQgTWVzc2FnZVwiLCBtYWlsT3B0aW9uc0FkbWluKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVE9UQUwgRU1BSUxTIFNFTlQ6IFwiICsgbWlzc2VkQ2xhc3Nlcy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk5vIG1pc3NlZCBjbGFzc2VzXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkdldCBhbGwgYXR0ZW5kYW5jZSBcIiArIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJHZXQgYWxsIGF0dGVuZGFuY2UgXCIgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XHJcbiAgICAgICAgfSk7XHJcbiAgfVxyXG4gIGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc29sZS5sb2coZXJyKTtcclxuICB9XHJcblxyXG59KTtcclxuIl19
